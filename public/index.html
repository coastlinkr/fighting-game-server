<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Fighter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
            height: 100vh;
            height: 100dvh;
        }
        canvas {
            display: block;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            touch-action: none;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
        }
        .controls {
            position: fixed;
            bottom: 2vh;
            left: 2vw;
            right: 2vw;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 1000;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            pointer-events: auto;
        }
        .move-controls {
            display: flex;
            gap: 1vw;
        }
        .action-controls {
            display: flex;
            flex-direction: column;
            gap: 1vh;
        }
        .control-btn {
            width: 15vw;
            height: 15vw;
            min-width: 60px;
            min-height: 60px;
            max-width: 80px;
            max-height: 80px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            font-size: 4vw;
            font-weight: bold;
            touch-action: manipulation;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }
        .control-btn:active {
            background: rgba(255, 255, 255, 1);
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .move-btn {
            background: rgba(100, 149, 237, 0.8);
            color: white;
        }
        .move-btn:active {
            background: rgba(100, 149, 237, 1);
        }
        .special-btn {
            background: rgba(255, 69, 0, 0.8);
            color: white;
            font-size: 3vw;
        }
        .special-btn:active {
            background: rgba(255, 69, 0, 1);
        }
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            text-align: center;
        }
        .menu-content, .lobby-content {
            max-width: 90vw;
            padding: 4vh 2vw;
        }
        .menu-title {
            font-size: 8vw;
            font-weight: bold;
            margin-bottom: 6vh;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .menu-btn {
            display: block;
            width: 80vw;
            max-width: 400px;
            padding: 4vh 4vw;
            margin: 3vh auto;
            border: none;
            border-radius: 2vh;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            font-size: 5vw;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .menu-btn:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .menu-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .secondary-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .secondary-btn:hover {
            background: linear-gradient(45deg, #1976D2, #2196F3);
        }
        .danger-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .danger-btn:hover {
            background: linear-gradient(45deg, #d32f2f, #f44336);
        }
        .lobby-info {
            font-size: 4vh;
            margin: 4vh 0;
            padding: 2vh;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1vh;
            border: 2px solid #FFD700;
        }
        .ready-status {
            font-size: 3vh;
            margin: 2vh 0;
            padding: 1vh;
            border-radius: 1vh;
        }
        .ready-true {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }
        .ready-false {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
        .connection-status {
            position: fixed;
            top: 2vh;
            right: 2vw;
            padding: 1vh 2vw;
            border-radius: 1vh;
            font-size: 3vw;
            font-weight: bold;
            z-index: 3000;
        }
        .connected {
            background: rgba(76, 175, 80, 0.8);
            color: white;
        }
        .disconnected {
            background: rgba(244, 67, 54, 0.8);
            color: white;
        }
        .game-hud {
            position: fixed;
            top: 2vh;
            left: 2vw;
            right: 2vw;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 1000;
            pointer-events: none;
        }
        .health-bar {
            width: 40vw;
            height: 3vh;
            background: rgba(244, 67, 54, 0.8);
            border: 2px solid white;
            border-radius: 1vh;
            overflow: hidden;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        .timer {
            font-size: 6vw;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 1vh 2vw;
            border-radius: 1vh;
        }
        @media (max-height: 500px) {
            .control-btn {
                width: 12vw;
                height: 12vw;
                font-size: 3vw;
            }
            .special-btn {
                font-size: 2.5vw;
            }
        }
        @media (orientation: landscape) and (max-height: 500px) {
            .controls {
                bottom: 1vh;
            }
            .control-btn {
                width: 10vh;
                height: 10vh;
                font-size: 2.5vh;
            }
        }
    </style>
</head>
<body>
    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Game HUD -->
    <div class="game-hud" id="gameHud" style="display: none;">
        <div>
            <div class="health-bar">
                <div class="health-fill" id="player1Health" style="width: 100%;"></div>
            </div>
            <div style="color: white; font-size: 3vw; margin-top: 1vh;">Player 1</div>
        </div>
        <div class="timer" id="gameTimer">60</div>
        <div>
            <div class="health-bar">
                <div class="health-fill" id="player2Health" style="width: 100%;"></div>
            </div>
            <div style="color: white; font-size: 3vw; margin-top: 1vh;">Player 2</div>
        </div>
    </div>
    
    <!-- Touch Controls -->
    <div class="controls" id="touchControls" style="display: none;">
        <div class="control-group">
            <div class="move-controls">
                <button class="control-btn move-btn" id="leftBtn">‚Üê</button>
                <button class="control-btn move-btn" id="rightBtn">‚Üí</button>
            </div>
        </div>
        <div class="control-group">
            <div class="action-controls">
                <button class="control-btn" id="punchBtn">üëä</button>
                <button class="control-btn" id="kickBtn">ü¶µ</button>
                <button class="control-btn special-btn" id="specialBtn">‚ö°</button>
            </div>
        </div>
    </div>
    
    <!-- Game Overlay (Menu/Lobby) -->
    <div class="game-overlay" id="gameOverlay">
        <!-- Main Menu -->
        <div class="menu-content" id="menuContent">
            <h1 class="menu-title">MOBILE FIGHTER</h1>
            <button class="menu-btn" onclick="createLobby()">üåê Create Lobby</button>
            <button class="menu-btn secondary-btn" onclick="startPracticeMode()">ü•ä Practice Mode</button>
        </div>
        
        <!-- Lobby Screen -->
        <div class="lobby-content" id="lobbyContent" style="display: none;">
            <h2 class="menu-title" style="font-size: 6vw;">LOBBY</h2>
            <div class="lobby-info" id="lobbyInfo">
                <div style="font-size: 4vh; margin: 2vh 0;">Connecting...</div>
            </div>
            <div class="ready-status" id="readyStatus">
                <div id="player1Ready">Player 1: Not Ready</div>
                <div id="player2Ready">Player 2: Waiting...</div>
            </div>
            <button class="menu-btn" id="readyBtn" onclick="toggleReady()" style="display: none;">Ready Up!</button>
            <button class="menu-btn danger-btn" onclick="backToMenu()">‚Üê Back to Menu</button>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus" style="display: none;">
        Connecting...
    </div>

    <!-- Socket.io Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        class FightingGameEngine {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.setupCanvas();
                this.setupNetworking();
                this.setupEventListeners();
                
                // Game state
                this.gameState = 'menu'; // 'menu', 'lobby', 'fighting'
                this.gameTime = 60;
                this.gameTimer = null;
                
                // Multiplayer state
                this.isMultiplayer = false;
                this.isHost = false;
                this.lobbyCode = null;
                this.playerId = Math.random().toString(36).substr(2, 9);
                this.playerReady = false;
                this.opponentReady = false;
                this.connected = false;
                
                // Players
                this.players = {};
                this.initializePlayers();
                
                // Input handling
                this.keys = {};
                this.touches = {};
                
                // Game loop
                this.lastTime = 0;
                this.gameLoop = this.gameLoop.bind(this);
                requestAnimationFrame(this.gameLoop);
                
                // Check for lobby join on load
                this.checkForLobbyJoin();
            }
            
            setupCanvas() {
                const resizeCanvas = () => {
                    const dpr = window.devicePixelRatio || 1;
                    const displayWidth = window.innerWidth;
                    const displayHeight = window.innerHeight;
                    
                    this.canvas.width = displayWidth * dpr;
                    this.canvas.height = displayHeight * dpr;
                    this.canvas.style.width = displayWidth + 'px';
                    this.canvas.style.height = displayHeight + 'px';
                    
                    this.ctx.scale(dpr, dpr);
                    
                    this.canvasWidth = displayWidth;
                    this.canvasHeight = displayHeight;
                };
                
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }
            
            setupNetworking() {
                const serverUrl = window.location.origin;
                this.socket = io(serverUrl);
                
                this.socket.on('connect', () => {
                    this.connected = true;
                    this.updateConnectionStatus(true);
                });
                
                this.socket.on('disconnect', () => {
                    this.connected = false;
                    this.updateConnectionStatus(false);
                });
                
                this.socket.on('lobby_created', (data) => {
                    this.lobbyCode = data.lobbyCode;
                    this.isHost = true;
                    this.updateLobbyDisplay();
                });
                
                this.socket.on('lobby_joined', (data) => {
                    this.lobbyCode = data.lobbyCode;
                    this.isHost = false;
                    this.updateLobbyDisplay();
                    document.getElementById('readyBtn').style.display = 'block';
                });
                
                this.socket.on('player_joined', (data) => {
                    this.updateLobbyDisplay();
                    document.getElementById('readyBtn').style.display = 'block';
                });
                
                this.socket.on('ready_status', (data) => {
                    this.playerReady = data.player1Ready;
                    this.opponentReady = data.player2Ready;
                    this.updateReadyDisplay();
                });
                
                this.socket.on('game_start', () => {
                    this.startMultiplayerGame();
                });
                
                this.socket.on('player_state', (data) => {
                    if (data.playerId !== this.playerId && this.players[2]) {
                        this.players[2].x = data.x;
                        this.players[2].y = data.y;
                        this.players[2].direction = data.direction;
                        this.players[2].currentAction = data.action;
                        this.players[2].health = data.health;
                    }
                });
                
                this.socket.on('lobby_error', (data) => {
                    alert(data.message);
                });
            }
            
            setupEventListeners() {
                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    e.preventDefault();
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                    e.preventDefault();
                });
                
                // Touch events for buttons
                const buttons = [
                    { id: 'leftBtn', action: 'moveLeft' },
                    { id: 'rightBtn', action: 'moveRight' },
                    { id: 'punchBtn', action: 'punch' },
                    { id: 'kickBtn', action: 'kick' },
                    { id: 'specialBtn', action: 'special' }
                ];
                
                buttons.forEach(button => {
                    const element = document.getElementById(button.id);
                    element.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.touches[button.action] = true;
                    });
                    element.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.touches[button.action] = false;
                    });
                    element.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.touches[button.action] = true;
                    });
                    element.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        this.touches[button.action] = false;
                    });
                });
                
                // Prevent context menu on long press
                document.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            initializePlayers() {
                this.players = {
                    1: {
                        x: this.canvasWidth * 0.25,
                        y: this.canvasHeight * 0.7,
                        width: 60,
                        height: 100,
                        health: 100,
                        maxHealth: 100,
                        direction: 1,
                        speed: 5,
                        jumpPower: 15,
                        velocityY: 0,
                        onGround: true,
                        currentAction: 'idle',
                        actionTimer: 0,
                        lastAttackTime: 0,
                        color: '#4CAF50'
                    },
                    2: {
                        x: this.canvasWidth * 0.75,
                        y: this.canvasHeight * 0.7,
                        width: 60,
                        height: 100,
                        health: 100,
                        maxHealth: 100,
                        direction: -1,
                        speed: 5,
                        jumpPower: 15,
                        velocityY: 0,
                        onGround: true,
                        currentAction: 'idle',
                        actionTimer: 0,
                        lastAttackTime: 0,
                        color: '#2196F3'
                    }
                };
            }
            
            updateConnectionStatus(connected) {
                const status = document.getElementById('connectionStatus');
                if (connected) {
                    status.textContent = 'Connected';
                    status.className = 'connection-status connected';
                } else {
                    status.textContent = 'Disconnected';
                    status.className = 'connection-status disconnected';
                }
            }
            
            checkForLobbyJoin() {
                const hash = window.location.hash.substring(1);
                if (hash && hash.match(/^\d{4}$/)) {
                    if (this.connected) {
                        this.joinLobby(hash);
                    } else {
                        this.socket.on('connect', () => {
                            this.joinLobby(hash);
                        });
                    }
                }
            }
            
            createLobby() {
                if (!this.connected) {
                    alert('Not connected to server. Please refresh and try again.');
                    return;
                }

                this.gameState = 'lobby';
                document.getElementById('menuContent').style.display = 'none';
                document.getElementById('lobbyContent').style.display = 'block';
                document.getElementById('connectionStatus').style.display = 'block';
                
                document.getElementById('lobbyInfo').innerHTML = `
                    <div style="font-size: 4vh; margin: 2vh 0;">Creating Lobby...</div>
                    <div style="font-size: 2vh; color: #BBB;">Please wait...</div>
                `;
                
                this.socket.emit('create_lobby', {
                    playerId: this.playerId
                });
            }
            
            joinLobby(code) {
                this.gameState = 'lobby';
                document.getElementById('menuContent').style.display = 'none';
                document.getElementById('lobbyContent').style.display = 'block';
                document.getElementById('connectionStatus').style.display = 'block';
                
                document.getElementById('lobbyInfo').innerHTML = `
                    <div style="font-size: 4vh; margin: 2vh 0;">Joining Lobby...</div>
                    <div style="font-size: 2vh; color: #BBB;">Code: ${code}</div>
                `;
                
                this.socket.emit('join_lobby', {
                    lobbyCode: code,
                    playerId: this.playerId
                });
            }
            
            updateLobbyDisplay() {
                if (this.lobbyCode) {
                    const shareUrl = `${window.location.origin}#${this.lobbyCode}`;
                    document.getElementById('lobbyInfo').innerHTML = `
                        <div style="font-size: 6vh; margin: 2vh 0; color: #FFD700;">${this.lobbyCode}</div>
                        <div style="font-size: 3vh; margin: 2vh 0;">Share this code with your friend!</div>
                        <div style="font-size: 2vh; word-break: break-all; color: #BBB;">${shareUrl}</div>
                    `;
                }
            }
            
            updateReadyDisplay() {
                const player1Status = document.getElementById('player1Ready');
                const player2Status = document.getElementById('player2Ready');
                
                player1Status.textContent = `Player 1: ${this.playerReady ? 'Ready!' : 'Not Ready'}`;
                player1Status.className = this.playerReady ? 'ready-true' : 'ready-false';
                
                player2Status.textContent = `Player 2: ${this.opponentReady ? 'Ready!' : 'Not Ready'}`;
                player2Status.className = this.opponentReady ? 'ready-true' : 'ready-false';
                
                const readyBtn = document.getElementById('readyBtn');
                readyBtn.textContent = this.playerReady ? 'Not Ready' : 'Ready Up!';
                readyBtn.className = this.playerReady ? 'menu-btn danger-btn' : 'menu-btn';
            }
            
            toggleReady() {
                this.playerReady = !this.playerReady;
                this.socket.emit('toggle_ready', {
                    playerId: this.playerId,
                    ready: this.playerReady
                });
                this.updateReadyDisplay();
            }
            
            startPracticeMode() {
                this.gameState = 'fighting';
                this.isMultiplayer = false;
                this.initializePlayers();
                document.getElementById('gameOverlay').style.display = 'none';
                document.getElementById('touchControls').style.display = 'flex';
                document.getElementById('gameHud').style.display = 'flex';
                document.getElementById('connectionStatus').style.display = 'none';
                this.gameTime = 60;
                this.startGameTimer();
            }
            
            startMultiplayerGame() {
                this.gameState = 'fighting';
                this.isMultiplayer = true;
                this.initializePlayers();
                document.getElementById('gameOverlay').style.display = 'none';
                document.getElementById('touchControls').style.display = 'flex';
                document.getElementById('gameHud').style.display = 'flex';
                this.gameTime = 60;
                this.startGameTimer();
            }
            
            startGameTimer() {
                this.gameTimer = setInterval(() => {
                    this.gameTime--;
                    document.getElementById('gameTimer').textContent = this.gameTime;
                    
                    if (this.gameTime <= 0) {
                        this.endGame('Time Up!');
                    }
                }, 1000);
            }
            
            backToMenu() {
                this.gameState = 'menu';
                document.getElementById('menuContent').style.display = 'block';
                document.getElementById('lobbyContent').style.display = 'none';
                document.getElementById('gameOverlay').style.display = 'flex';
                document.getElementById('touchControls').style.display = 'none';
                document.getElementById('gameHud').style.display = 'none';
                document.getElementById('connectionStatus').style.display = 'none';
                
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                    this.gameTimer = null;
                }
                
                if (this.lobbyCode) {
                    this.socket.emit('leave_lobby', { playerId: this.playerId });
                    this.lobbyCode = null;
                    this.playerReady = false;
                    this.opponentReady = false;
                }
                
                window.location.hash = '';
            }
            
            handleInput(player) {
                const p = this.players[player];
                const now = Date.now();
                
                // Movement controls
                let moving = false;
                if ((player === 1 && (this.keys['ArrowLeft'] || this.keys['KeyA'] || this.touches['moveLeft'])) ||
                    (player === 2 && (this.keys['ArrowLeft'] || this.keys['KeyA']) && !this.isMultiplayer)) {
                    p.x -= p.speed;
                    p.direction = -1;
                    moving = true;
                }
                if ((player === 1 && (this.keys['ArrowRight'] || this.keys['KeyD'] || this.touches['moveRight'])) ||
                    (player === 2 && (this.keys['ArrowRight'] || this.keys['KeyD']) && !this.isMultiplayer)) {
                    p.x += p.speed;
                    p.direction = 1;
                    moving = true;
                }
                
                // Jump
                if ((player === 1 && (this.keys['Space'] || this.keys['ArrowUp'] || this.keys['KeyW'])) ||
                    (player === 2 && (this.keys['ArrowUp'] || this.keys['KeyW']) && !this.isMultiplayer)) {
                    if (p.onGround) {
                        p.velocityY = -p.jumpPower;
                        p.onGround = false;
                    }
                }
                
                // Attack controls
                if ((player === 1 && (this.keys['KeyZ'] || this.touches['punch'])) ||
                    (player === 2 && this.keys['Numpad1'] && !this.isMultiplayer)) {
                    if (now - p.lastAttackTime > 300) {
                        this.performAttack(player, 'punch');
                        p.lastAttackTime = now;
                    }
                }
                if ((player === 1 && (this.keys['KeyX'] || this.touches['kick'])) ||
                    (player === 2 && this.keys['Numpad2'] && !this.isMultiplayer)) {
                    if (now - p.lastAttackTime > 400) {
                        this.performAttack(player, 'kick');
                        p.lastAttackTime = now;
                    }
                }
                if ((player === 1 && (this.keys['KeyC'] || this.touches['special'])) ||
                    (player === 2 && this.keys['Numpad3'] && !this.isMultiplayer)) {
                    if (now - p.lastAttackTime > 800) {
                        this.performAttack(player, 'special');
                        p.lastAttackTime = now;
                    }
                }
                
                // Update action
                if (p.actionTimer <= 0) {
                    if (moving) {
                        p.currentAction = 'walking';
                    } else {
                        p.currentAction = 'idle';
                    }
                }
                
                // Boundary check
                p.x = Math.max(p.width/2, Math.min(this.canvasWidth - p.width/2, p.x));
            }
            
            performAttack(playerNum, attackType) {
                const attacker = this.players[playerNum];
                const target = this.players[playerNum === 1 ? 2 : 1];
                
                attacker.currentAction = attackType;
                attacker.actionTimer = attackType === 'special' ? 60 : (attackType === 'kick' ? 40 : 30);
                
                // Check if attack hits
                const distance = Math.abs(attacker.x - target.x);
                const attackRange = attackType === 'special' ? 120 : 80;
                
                if (distance < attackRange) {
                    const damage = attackType === 'special' ? 25 : (attackType === 'kick' ? 15 : 10);
                    target.health -= damage;
                    target.health = Math.max(0, target.health);
                    
                    // Knockback
                    const knockback = attackType === 'special' ? 30 : 15;
                    target.x += attacker.direction * knockback;
                    target.x = Math.max(target.width/2, Math.min(this.canvasWidth - target.width/2, target.x));
                    
                    this.updateHealthDisplay();
                    
                    if (target.health <= 0) {
                        this.endGame(`Player ${playerNum} Wins!`);
                    }
                }
            }
            
            updatePhysics(player) {
                const p = this.players[player];
                
                // Gravity
                p.velocityY += 0.8;
                p.y += p.velocityY;
